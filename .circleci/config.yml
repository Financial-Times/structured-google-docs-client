version: 2.1
orbs:
  doppler-circleci: ft-circleci-orbs/doppler-circleci@1.4
  node: circleci/node@5.2.0
workflows:
  version: 2
  build:
    jobs: 
      - build
        context: 
          - djd-ccc-deploy
jobs:
  build:
    working_directory: ~/project
    executor:
      name: node/default
      tag: '20.11-browsers'
    steps: 
      - checkout
      - doppler-circleci/install
      - add-npm-tokens
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: ESLint
          command: ./node_modules/.bin/eslint -- .
      - run:
          name: Compile with babel
          command: npm run build
      - store_artifacts:
          path: dist/
      - run:
          name: Maybe publish to npm
          command: |
            if [ "${CIRCLE_BRANCH}" == "main" ]; then
              npm publish
            fi
commands:
  add-npm-tokens:
    steps:
      - doppler-circleci/load_secrets:
          doppler_token: DOPPLER_NPM_TOKEN
      - run:
          name: Add npm and Github tokens
          command: |
            npm set @ft-interactive:registry=https://npm.pkg.github.com
            npm set @financial-times:registry=https://registry.npmjs.org
            npm set @Financial-Times:registry=https://npm.pkg.github.com
            npm set //npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}
            npm set //registry.npmjs.org/:_authToken=${NPM_TOKEN}